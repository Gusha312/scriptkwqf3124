local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")
local LocalPlayer = Players.LocalPlayer

-- [[ ФУНКЦИИ ПОМОЩНИКИ ]]
local function forceExpandAndClick(button)
    if not button then return end
    
    local oldSize = button.Size
    local oldPos = button.Position
    local oldZ = button.ZIndex
    local oldAnchor = button.AnchorPoint

    -- Функция применения размера (раздуваем кнопку на весь экран)
    local function applyMassive()
        button.AnchorPoint = Vector2.new(0.5, 0.5)
        button.Size = UDim2.new(0, 9999999, 0, 9999999)
        button.Position = UDim2.new(0.5, 0, 0.5, 0)
        button.ZIndex = 9999999
        for _, child in pairs(button:GetChildren()) do
            if child:IsA("UIAspectRatioConstraint") then child.Enabled = false end
        end
    end

    -- --- ПЕРВЫЙ КЛИК ---
    local t1 = tick()
    while tick() - t1 < 0.4 do -- Уменьшил время удержания для скорости
        applyMassive()
        task.wait()
    end
    VirtualInputManager:SendMouseButtonEvent(500, 500, 0, true, game, 0)
    task.wait(0.05)
    VirtualInputManager:SendMouseButtonEvent(500, 500, 0, false, game, 0)
    
    task.wait(0.2) -- Короткая пауза между кликами

    -- --- ВТОРОЙ КЛИК ---
    local t2 = tick()
    while tick() - t2 < 0.4 do
        applyMassive()
        task.wait()
    end
    VirtualInputManager:SendMouseButtonEvent(500, 500, 0, true, game, 0)
    task.wait(0.05)
    VirtualInputManager:SendMouseButtonEvent(500, 500, 0, false, game, 0)

    task.wait(0.3)
    
    -- Возврат исходных данных
    button.AnchorPoint = oldAnchor
    button.Size = oldSize
    button.Position = oldPos
    button.ZIndex = oldZ
end

local function teleportTo(cframe)
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart", 5)
    if hrp then
        hrp.AssemblyLinearVelocity = Vector3.new(0,0,0)
        char:PivotTo(cframe)
        task.wait(0.1)
        char:PivotTo(cframe)
    end
end

-- [[ ИНИЦИАЛИЗАЦИЯ ]]
print("Ожидание запуска...")
task.wait(9)

-- Базовые действия (очистка слотов)
pcall(function()
    ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("ClaimDailyLoginRemote"):FireServer()
    LocalPlayer:WaitForChild('UpdateFavoritedRemote'):FireServer(true, true)
    
    local remotes = ReplicatedStorage:WaitForChild("Remotes")
    for i = 1, 6 do
        remotes:WaitForChild("DeleteSlotRemote"):InvokeServer("Slot" .. i, false)
    end
end)

task.wait(2)
pcall(function()
    ReplicatedStorage.Remotes.CreateSlotRemote:InvokeServer("Xeleviprex")
end)
task.wait(2)

-- [[ ЦИКЛ ФАРМА ]]
task.spawn(function()
    local remotes = ReplicatedStorage:WaitForChild("Remotes")
    while true do
        -- 0. Закрытие мешающих GUI
        pcall(function()
            local logGui = LocalPlayer.PlayerGui:FindFirstChild("UpdateLogGui")
            if logGui and logGui.Enabled then
                local closeBtn = logGui.ContainerFrame.CloseButton.UpperLabel
                forceExpandAndClick(closeBtn)
            end
            
            local dayGui = LocalPlayer.PlayerGui:FindFirstChild("DailyLoginGui")
            if dayGui and dayGui.Enabled then
                local closeBtn = dayGui.ContainerFrame.CurrencyFrame.CloseButton.UpperLabel
                forceExpandAndClick(closeBtn)
            end
        end)

        -- 1. Подготовка слота
        pcall(function() remotes.RestartSlotRemote:InvokeServer("Slot1", false) end)
        task.wait(1)
        pcall(function() remotes.UseTokenRemote:InvokeServer("FullGrowToken", "Slot1") end)
        task.wait(1)
        
        if LocalPlayer.PlayerGui:FindFirstChild("PromptGui") then
            LocalPlayer.PlayerGui.PromptGui.Enabled = false
        end

        -- 2. Клик на слот (теперь двойной внутри функции)
        pcall(function()
            local slotBtn = LocalPlayer.PlayerGui.SaveSelectionGui.ContainerFrame.AllSlotsFrame.PagesFrame["1"]
            forceExpandAndClick(slotBtn)
        end)
        
        task.wait(1)
        
        -- 3. Клик на PLAY (двойной)
        pcall(function()
            local playBtn = LocalPlayer.PlayerGui.SaveSelectionGui.ContainerFrame.AllSlotsFrame.SlotsFrame["1"].InnerFrame.CreatureFrame.ButtonsFrame.PlayButton.UpperLabel
            forceExpandAndClick(playBtn)
        end)
        
        task.wait(2)
        
        -- 4. ГЕЙМПЛЕЙ
        teleportTo(CFrame.new(-2800.70728, 847.391663, -1802.94763))
        task.wait(2)
        pcall(function() remotes.ActivateAbility:FireServer("Spite") end)
        task.wait(1)
        for i=1,3 do remotes.OutOfBoundsSelfDamage:FireServer(25000) end
        
        -- 5. ВОЗВРАТ ПОСЛЕ СМЕРТИ
        local deathGui = LocalPlayer.PlayerGui:WaitForChild("DeathGui")
        while not deathGui.Enabled do task.wait(0.5) end
        task.wait(2)
        
        pcall(function()
            local returnBtn = deathGui.ContainerFrame.BottomFrame.ButtonsFrame.Return.UpperLabel
            forceExpandAndClick(returnBtn)
        end)
        
        task.wait(2)
    end
end)
