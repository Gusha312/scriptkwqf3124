-- –£–ª—å—Ç—Ä–∞-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è Roblox
-- –ê–≤—Ç–æ—Ä: –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä

local _G = _G
local table = table
local math = math
local string = string
local Vector3 = Vector3
local CFrame = CFrame
local Instance = Instance
local task = task
local table_insert = table.insert
local table_remove = table.remove
local math_floor = math.floor
local math_random = math.random
local math_clamp = math.clamp

-- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
local localPlayer = Players.LocalPlayer
while not localPlayer do
    task.wait()
    localPlayer = Players.LocalPlayer
end

local camera = Workspace.CurrentCamera

-- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
local UPDATE_RATE = 1/30
local MAX_OBJECTS = 50  -- –ú–µ–Ω—å—à–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
local OPTIMIZATION_THRESHOLD = 0.016

-- –ü—É–ª—ã –æ–±—ä–µ–∫—Ç–æ–≤
local objectPool = {}
local activeObjects = {}
local connection = nil

-- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —á–∞—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ)
local function CreateClientPart()
    local part = Instance.new("Part")
    part.Anchored = true
    part.CanCollide = false
    part.Material = Enum.Material.Plastic
    part.Size = Vector3.new(2, 2, 2)
    part.BrickColor = BrickColor.random()
    part.CastShadow = false  -- –í—ã–∫–ª—é—á–∞–µ–º —Ç–µ–Ω–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    part.Parent = nil
    return part
end

-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
local function PreallocateObjects()
    for i = 1, MAX_OBJECTS do
        objectPool[i] = CreateClientPart()
    end
end

-- –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ –ø—É–ª–∞
local function GetFromPool()
    if #objectPool > 0 then
        local obj = table_remove(objectPool)
        table_insert(activeObjects, obj)
        return obj
    end
    return nil
end

-- –í–æ–∑–≤—Ä–∞—Ç –æ–±—ä–µ–∫—Ç–∞ –≤ –ø—É–ª
local function ReturnToPool(obj)
    if obj then
        obj.Parent = nil
        for i, activeObj in ipairs(activeObjects) do
            if activeObj == obj then
                table_remove(activeObjects, i)
                break
            end
        end
        table_insert(objectPool, obj)
    end
end

-- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –∫–∞–º–µ—Ä—ã
local function OptimizedUpdate(deltaTime)
    if not camera then return end
    
    local cameraPos = camera.CFrame.Position
    
    for i = #activeObjects, 1, -1 do
        local obj = activeObjects[i]
        if obj and obj.Parent then
            -- –î–≤–∏–∂–µ–Ω–∏–µ –ø–æ –∫—Ä—É–≥—É –≤–æ–∫—Ä—É–≥ –∫–∞–º–µ—Ä—ã
            local angle = tick() * 2 + i * 0.5
            local radius = 10 + (i % 5)
            
            local offset = Vector3.new(
                math.cos(angle) * radius,
                math.sin(angle) * 0.5,
                math.sin(angle) * radius
            )
            
            obj.Position = cameraPos + offset
            
            -- –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Ü–≤–µ—Ç–∞
            obj.BrickColor = BrickColor.new(Color3.fromHSV(
                (math.sin(tick() * 0.5 + i * 0.1) + 1) * 0.5,
                0.8, 1
            ))
        end
    end
end

-- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–ø–∞–≤–Ω —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
local function ClientSpawn()
    if not camera then return end
    
    local obj = GetFromPool()
    if obj then
        obj.Parent = Workspace
        obj.Position = camera.CFrame.Position + Vector3.new(
            math_random(-15, 15),
            math_random(-5, 5),
            math_random(-15, 15)
        )
    end
end

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∞–ª–µ–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
local function CleanupDistantObjects()
    if not camera then return end
    
    local cameraPos = camera.CFrame.Position
    
    for i = #activeObjects, 1, -1 do
        local obj = activeObjects[i]
        if obj and obj.Parent then
            local distance = (obj.Position - cameraPos).Magnitude
            if distance > 50 then
                ReturnToPool(obj)
            end
        end
    end
end

-- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π FPS –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
local lastUpdate = 0
local frameCount = 0
local currentFPS = 60

local function AdaptiveUpdate(deltaTime)
    frameCount = frameCount + 1
    
    -- –°—á–∏—Ç–∞–µ–º FPS –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    if tick() - lastUpdate >= 1 then
        currentFPS = frameCount
        frameCount = 0
        lastUpdate = tick()
    end
    
    -- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–µ–≥—É–ª–∏—Ä—É–µ–º —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    local targetRate = math_clamp(1 / currentFPS, 1/60, 1/10)
    
    if deltaTime < targetRate then
        OptimizedUpdate(deltaTime)
    end
end

-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ü–∏–∫–ª
local function StartClientLoop()
    if connection then
        connection:Disconnect()
    end
    
    connection = RunService.Heartbeat:Connect(function(deltaTime)
        local startTime = tick()
        
        AdaptiveUpdate(deltaTime)
        
        -- –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–∞–≥–æ–≤
        local processingTime = tick() - startTime
        if processingTime > OPTIMIZATION_THRESHOLD then
            -- –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏ –ª–∞–≥–∞—Ö
            UPDATE_RATE = math_clamp(UPDATE_RATE * 1.2, 1/30, 1/5)
        else
            -- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É FPS
            UPDATE_RATE = math_clamp(UPDATE_RATE * 0.95, 1/60, 1/10)
        end
    end)
end

-- UI –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
local function CreatePerformanceMonitor()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PerformanceMonitor"
    screenGui.Parent = localPlayer:WaitForChild("PlayerGui")
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 200, 0, 80)
    frame.Position = UDim2.new(0, 10, 0, 10)
    frame.BackgroundColor3 = Color3.new(0, 0, 0)
    frame.BackgroundTransparency = 0.3
    frame.BorderSizePixel = 0
    frame.Parent = screenGui
    
    local fpsLabel = Instance.new("TextLabel")
    fpsLabel.Size = UDim2.new(1, 0, 0.5, 0)
    fpsLabel.BackgroundTransparency = 1
    fpsLabel.Text = "FPS: 60"
    fpsLabel.TextColor3 = Color3.new(1, 1, 1)
    fpsLabel.TextXAlignment = Enum.TextXAlignment.Left
    fpsLabel.Parent = frame
    
    local objectsLabel = Instance.new("TextLabel")
    objectsLabel.Size = UDim2.new(1, 0, 0.5, 0)
    objectsLabel.Position = UDim2.new(0, 0, 0.5, 0)
    objectsLabel.BackgroundTransparency = 1
    objectsLabel.Text = "Objects: 0/50"
    objectsLabel.TextColor3 = Color3.new(1, 1, 1)
    objectsLabel.TextXAlignment = Enum.TextXAlignment.Left
    objectsLabel.Parent = frame
    
    -- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    spawn(function()
        while screenGui.Parent do
            task.wait(0.5)
            fpsLabel.Text = "FPS: " .. math_floor(currentFPS)
            objectsLabel.Text = "Objects: " .. #activeObjects .. "/" .. MAX_OBJECTS
        end
    end)
    
    return screenGui
end

-- –û—á–∏—Å—Ç–∫–∞
local function Cleanup()
    if connection then
        connection:Disconnect()
        connection = nil
    end
    
    for i = #activeObjects, 1, -1 do
        ReturnToPool(activeObjects[i])
    end
end

-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
local function InitializeClient()
    PreallocateObjects()
    StartClientLoop()
    
    -- –°–æ–∑–¥–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    CreatePerformanceMonitor()
    
    -- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–ø–∞–≤–Ω –æ–±—ä–µ–∫—Ç–æ–≤
    spawn(function()
        while true do
            task.wait(0.5)
            ClientSpawn()
        end
    end)
    
    -- –û—á–∏—Å—Ç–∫–∞ –¥–∞–ª–µ–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    spawn(function()
        while true do
            task.wait(2)
            CleanupDistantObjects()
        end
    end)
    
    print("‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω!")
    print("üìä –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤: " .. MAX_OBJECTS)
    print("üéØ –¶–µ–ª–µ–≤–æ–π FPS: 30-60")
end

-- –ó–∞–ø—É—Å–∫ —Å –∑–∞—â–∏—Ç–æ–π
local success, err = pcall(InitializeClient)
if not success then
    warn("‚ùå –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç —É–ø–∞–ª:", err)
    Cleanup()
end

-- –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
localPlayer.CharacterRemoving:Connect(function()
    Cleanup()
end)

game:GetService("LogService").MessageOut:Connect(function(message)
    if string.find(message, "Kick") or string.find(message, "Disconnect") then
        Cleanup()
    end
end)

return {
    Initialize = InitializeClient,
    Cleanup = Cleanup,
    SpawnObject = ClientSpawn,
    GetStats = function()
        return {
            FPS = currentFPS,
            ActiveObjects = #activeObjects,
            PoolSize = #objectPool,
            UpdateRate = UPDATE_RATE
        }
    end
}
