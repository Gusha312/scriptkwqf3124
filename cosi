local player = game:GetService("Players").LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local TradeGui = player.PlayerGui:WaitForChild("Trade")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")

-- Настройки
local FARM_WORLD = 5233782396
local REQUIRED_AMOUNT = 12000
local ITEM_TYPE = "Shoom"
local COOLDOWN = 6
local MAX_ATTEMPTS = 30
local TRADE_DISTANCE = 15

-- Телепорт к дереву (однократно)
local target = game:GetService('Workspace')['Map Assets'].Trees.BoarderTree.Leaves
local function teleportToTarget()
    local rootPart = character:FindFirstChild('HumanoidRootPart') or character:WaitForChild('HumanoidRootPart')
    rootPart.CFrame = target.CFrame + Vector3.new(0, 3, 0)
    print("Телепорт к дереву выполнен")
end
teleportToTarget()

-- Логирование
local function log(msg)
    print("[TRADE BOT]", os.date("%H:%M:%S"), msg)
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Трейд бот",
        Text = msg,
        Duration = 5
    })
end

-- Определение роли
local function determineRole()
    local coins = player.Data.Coins.Value
    return coins < 100000 -- true = получатель, false = отправитель
end

-- Поиск партнера
local function findTradePartner()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character then
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
            if hrp and (hrp.Position - character.HumanoidRootPart.Position).Magnitude < TRADE_DISTANCE then
                return plr
            end
        end
    end
    return nil
end

-- Отправка запроса на трейд
local function sendTradeRequest(partner)
    for attempt = 1, 3 do
        ReplicatedStorage.TradeMasterEvent:FireServer("RequestTradeWithAsync", partner)
        log("Отправка запроса трейда (попытка "..attempt..")")
        
        local waitTime = 0
        while waitTime < 5 do
            if TradeGui.Enabled then return true end
            waitTime = waitTime + 0.5
            task.wait(0.5)
        end
    end
    return false
end

-- Логика получателя (проверяем ТОЛЬКО Them ячейки)
local function receiverLogic()
    log("Проверяю ячейки отправителя (Them)...")
    
    local attempts = 0
    while attempts < MAX_ATTEMPTS and TradeGui.Enabled do
        local allCorrect = true
        for i = 1, 3 do
            local cell = TradeGui.BG.Them[tostring(i)].TextLabel
            if not cell or tonumber(cell.Text) ~= REQUIRED_AMOUNT then
                allCorrect = false
                break
            end
        end
        
        if allCorrect then
            ReplicatedStorage.TradeMasterEvent:FireServer("ToggleReadyStateAsync")
            log("Все грибы получены! Трейд завершен.")
            return true
        end
        
        attempts = attempts + 1
        task.wait(1)
    end
    log("Не удалось получить грибы")
    return false
end

-- Логика отправителя (проверяем ТОЛЬКО Player2Ready)
local function senderLogic()
    log("Отправляю грибы...")
    
    -- Отправка предметов
    for i = 1, 3 do
        ReplicatedStorage.TradeMasterEvent:FireServer("AddItemAsync", {
            Amount = REQUIRED_AMOUNT,
            Type = ITEM_TYPE
        })
        task.wait(0.5)
    end
    
    -- Ожидание реального подтверждения
    local attempts = 0
    while attempts < MAX_ATTEMPTS and TradeGui.Enabled do
        local readyText = TradeGui.BG:FindFirstChild("Player2Ready") and TradeGui.BG.Player2Ready.Text or ""
        
        -- Точная проверка подтверждения
        if readyText:match("They Accepted") or readyText:match("Готов") then
            ReplicatedStorage.TradeMasterEvent:FireServer("ToggleReadyStateAsync")
            log("Партнер действительно подтвердил трейд!")
            
            -- Телепорт если мало денег
            if player.Data.Coins.Value < 13000 then
                TeleportService:Teleport(FARM_WORLD, player)
            end
            return true
        end
        
        attempts = attempts + 1
        task.wait(1)
    end
    log("Партнер не подтвердил трейд")
    return false
end

-- Основной цикл
local function main()
    while true do
        local isReceiver = determineRole()
        local partner = findTradePartner()
        
        if partner then
            log("Найден партнер: "..partner.Name)
            log("Роль: "..(isReceiver and "ПОЛУЧАТЕЛЬ" or "ОТПРАВИТЕЛЬ"))
            
            if sendTradeRequest(partner) then
                if isReceiver then
                    receiverLogic()
                else
                    senderLogic()
                end
            end
        else
            log("Партнер не найден рядом")
        end
        
        log("Ожидание "..COOLDOWN.." сек...")
        task.wait(COOLDOWN)
    end
end

-- Запуск
log("Автотрейдер запущен!")
pcall(main)
